name: GravityBridge Maintenance

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - restart
        - deploy
      target:
        description: 'Target Agent Name (Required for deploy, Optional for restart)'
        required: false
        type: string
      tunnel_id:
        description: 'Tunnel ID (UUID) - Required for new deployments if DNS not set'
        required: false
        type: string

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          pip install requests

      - name: Setup Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Configure SSH
        env:
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "Host *.hhwpxh.com *.555606.xyz" >> ~/.ssh/config
          echo "    User sw" >> ~/.ssh/config
          echo "    StrictHostKeyChecking no" >> ~/.ssh/config
          # Using cloudflared access ssh. 
          echo "    ProxyCommand cloudflared access ssh --hostname %h" >> ~/.ssh/config

      - name: Run Maintenance Script
        env:
          AGENTS_JSON_URL: ${{ secrets.AGENTS_JSON_URL }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # Cloudflare Secrets (Optional, for Deploy feature)
          CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          CF_API_KEY: ${{ secrets.CF_API_KEY }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
        run: |
          python3 maintenance.py --action ${{ inputs.action }} --target "${{ inputs.target }}" --tunnel-id "${{ inputs.tunnel_id }}"
