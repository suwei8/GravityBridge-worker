name: GravityBridge Maintenance

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'check'
        type: choice
        options:
        - check
        - restart

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          pip install requests

      - name: Setup Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Configure SSH
        env:
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "Host *.hhwpxh.com *.555606.xyz" >> ~/.ssh/config
          echo "    User sw" >> ~/.ssh/config
          echo "    StrictHostKeyChecking no" >> ~/.ssh/config
          # Using cloudflared access ssh. 
          # NOTE: Requires Cloudflare Service Token or Access bypass for automated flows.
          # Here we assume --hostname %h works if no Auth required or if CF_ACCESS_CLIENT_ID/SECRET provided via ENV
          echo "    ProxyCommand cloudflared access ssh --hostname %h" >> ~/.ssh/config

      - name: Run Maintenance Script
        env:
          AGENTS_JSON_URL: ${{ secrets.AGENTS_JSON_URL }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 maintenance.py --action ${{ inputs.action }}
